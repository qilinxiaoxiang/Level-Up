# Revelation Continuity & Daily Summaries

## Overview

This document extends the Revelation feature with **temporal continuity** - tracking plans over time, summarizing daily progress, and providing the LLM with historical context to create more meaningful, connected guidance.

## Core Concept: The Legend Unfolds Day by Day

Instead of treating each Revelation as isolated, we create a **narrative thread** that connects:
- Yesterday's summary (what happened)
- Last plan given (what was intended)
- Today's new plan (what comes next)

This creates:
- **Continuity**: Each day builds on the last
- **Reflection**: Users see their progress story
- **Learning**: LLM adapts based on what actually happened vs what was planned
- **Accountability**: Plans are tracked and reviewed
- **Meaning**: The journey becomes a cohesive narrative, not disconnected moments

---

## Database Schema

### 1. New Table: `revelation_plans`

Stores each plan generated by Revelation.

```sql
CREATE TABLE revelation_plans (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  -- Day this plan is for (using user's day cut time)
  plan_date DATE NOT NULL,

  -- The full revelation response (JSON)
  revelation_text TEXT NOT NULL,              -- The epic proclamation
  next_quest JSONB NOT NULL,                  -- The recommended quest
  witnessing JSONB,                           -- Victories, struggles, growth
  todays_plan JSONB,                          -- Morning/afternoon/evening narrative
  wisdom TEXT,                                -- Wisdom for the journey

  -- User input at time of revelation
  user_context TEXT,                          -- Optional message user shared

  -- Tracking
  was_quest_started BOOLEAN DEFAULT false,    -- Did they start the quest?
  quest_completed_at TIMESTAMP WITH TIME ZONE,

  -- Metadata
  model_used TEXT,                            -- 'gemini-1.5-pro' or 'gpt-4o'
  tokens_used INTEGER,

  CONSTRAINT unique_user_plan_date UNIQUE(user_id, plan_date)
);

CREATE INDEX idx_revelation_plans_user_date ON revelation_plans(user_id, plan_date DESC);
CREATE INDEX idx_revelation_plans_created ON revelation_plans(user_id, created_at DESC);
```

### 2. New Table: `daily_summaries`

Stores end-of-day summaries (generated when user gets first Revelation of next day).

```sql
CREATE TABLE daily_summaries (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) NOT NULL,

  -- The day being summarized
  summary_date DATE NOT NULL,

  -- When this summary was generated (usually next morning)
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  -- The plan that existed for this day
  plan_id UUID REFERENCES revelation_plans(id),

  -- Actual performance data
  summary_data JSONB NOT NULL,
  -- Structure:
  -- {
  --   pomodoros_completed: number,
  --   tasks_completed: string[],  // task titles
  --   tasks_attempted: string[],
  --   daily_tasks_done: boolean,
  --   total_minutes: number,
  --   plan_adherence: 'followed' | 'partially' | 'diverged' | 'no_plan'
  -- }

  -- LLM-generated narrative summary
  narrative_summary TEXT,
  -- Epic narrative about the day: victories, struggles, lessons learned
  -- Generated by LLM when analyzing the day

  -- Character development insights
  growth_insights JSONB,
  -- {
  --   strengths_shown: string[],
  --   challenges_faced: string[],
  --   patterns_noticed: string
  -- }

  CONSTRAINT unique_user_summary_date UNIQUE(user_id, summary_date)
);

CREATE INDEX idx_daily_summaries_user_date ON daily_summaries(user_id, summary_date DESC);
```

### 3. Update Existing Table: `revelation_plans` tracking

Add trigger to track quest completion:

```sql
-- Function to track when a task from a plan is completed
CREATE OR REPLACE FUNCTION track_revelation_quest_completion()
RETURNS TRIGGER AS $$
DECLARE
  latest_plan UUID;
BEGIN
  -- If a task was just completed, check if it matches today's revelation quest
  IF NEW.is_completed = true AND (OLD.is_completed = false OR OLD.is_completed IS NULL) THEN

    -- Get today's revelation plan
    SELECT id INTO latest_plan
    FROM revelation_plans
    WHERE user_id = NEW.user_id
      AND plan_date = CURRENT_DATE
      AND (next_quest->>'taskId') = NEW.id::text
    LIMIT 1;

    -- If this task matches today's quest, mark it
    IF latest_plan IS NOT NULL THEN
      UPDATE revelation_plans
      SET
        was_quest_started = true,
        quest_completed_at = NEW.completed_at
      WHERE id = latest_plan;
    END IF;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER track_quest_completion
  AFTER UPDATE ON tasks
  FOR EACH ROW
  EXECUTE FUNCTION track_revelation_quest_completion();
```

---

## Data Flow: Day Transition

### Scenario: User seeks Revelation in the morning

#### Step 1: Check if new day

```typescript
// In Edge Function
const now = new Date();
const userLocalDate = getLocalDateString(user.timezone, user.dayCutTime);

// Get last plan
const lastPlan = await getLastRevelationPlan(userId);

const isNewDay = !lastPlan || lastPlan.plan_date !== userLocalDate;
```

#### Step 2: If new day, generate yesterday's summary

```typescript
if (isNewDay && lastPlan) {
  // Get yesterday's date
  const yesterdayDate = lastPlan.plan_date;

  // Check if summary already exists
  const existingSummary = await getDailySummary(userId, yesterdayDate);

  if (!existingSummary) {
    // Collect yesterday's data
    const yesterdayData = await collectYesterdayData(userId, yesterdayDate);

    // Generate summary via LLM
    const summary = await generateDailySummary({
      user_id: userId,
      date: yesterdayDate,
      plan: lastPlan,
      actualData: yesterdayData
    });

    // Store summary
    await saveDailySummary(summary);
  }
}
```

#### Step 3: Include in context for new plan

```typescript
const revelationContext = {
  ...standardContext,
  lastPlan: lastPlan || null,
  yesterdaySummary: yesterdaySummary || null,
  isNewDay: isNewDay
};
```

---

## LLM Prompts - Enhanced with Continuity

### Daily Summary Generation Prompt

**Triggered**: When user seeks first Revelation of a new day

```
You are Revelation, chronicling the hero's journey through time.

A new day has dawned. Before we chart the path forward, we must honor yesterday's chapter.

YESTERDAY'S PLAN (${yesterdayDate}):
Plan created at: ${lastPlan.created_at}

The Quest Given:
- ${lastPlan.next_quest.title}
- Reason: ${lastPlan.next_quest.epicReason}

${lastPlan.todays_plan ? `
The Day's Adventure Planned:
Morning: ${lastPlan.todays_plan.morning}
Afternoon: ${lastPlan.todays_plan.afternoon}
Evening: ${lastPlan.todays_plan.evening}
` : ''}

WHAT ACTUALLY HAPPENED:
- Pomodoros completed: ${actualData.pomodoros_completed}
- Total time invested: ${actualData.total_minutes} minutes
- Tasks completed: ${actualData.tasks_completed.join(', ') || 'none'}
- Tasks attempted: ${actualData.tasks_attempted.join(', ') || 'none'}
- Daily disciplines completed: ${actualData.daily_tasks_done ? 'Yes ‚úì' : 'No'}
- Recommended quest status: ${actualData.quest_status}

GENERATE A NARRATIVE SUMMARY:

Provide a JSON response:
{
  "narrative_summary": "A brief, epic narrative (2-3 sentences) about yesterday's journey. Celebrate victories, acknowledge struggles, find meaning in what happened.",

  "growth_insights": {
    "strengths_shown": ["string - qualities they demonstrated"],
    "challenges_faced": ["string - obstacles encountered"],
    "pattern_noticed": "string - any recurring pattern (optional)"
  },

  "plan_adherence": "followed" | "partially_followed" | "diverged" | "exceeded",

  "lessons_for_today": "string - one key insight to carry forward"
}

GUIDELINES:
- Be honest but compassionate about divergence from plan
- Celebrate even small victories
- Frame challenges as part of the hero's journey
- Find meaning in what happened, even if plan wasn't followed
- Make them feel witnessed and understood
```

### Main Revelation Prompt - Enhanced

**Added sections** to the existing prompt:

```
[After all the existing context sections, ADD:]

CONTINUITY - YOUR JOURNEY CONTINUES:

${lastPlan ? `
YESTERDAY'S PLAN (${lastPlan.plan_date}):
Created at: ${formatTime(lastPlan.created_at)}

The quest I gave you:
- ${lastPlan.next_quest.title}
- Why it mattered: ${lastPlan.next_quest.epicReason}

${yesterdaySummary ? `
YESTERDAY'S CHAPTER (${yesterdaySummary.summary_date}):

What unfolded:
${yesterdaySummary.narrative_summary}

Strengths you showed:
${yesterdaySummary.growth_insights.strengths_shown.map(s => `- ${s}`).join('\n')}

Challenges you faced:
${yesterdaySummary.growth_insights.challenges_faced.map(c => `- ${c}`).join('\n')}

Plan adherence: ${yesterdaySummary.plan_adherence}

Lesson to carry forward:
${yesterdaySummary.lessons_for_today}
` : 'Yesterday has passed into legend, but its data speaks...'}
` : 'This is your first Revelation. Your legend begins now.'}

[Then continue with existing prompt...]

CRITICAL ADDITIONS TO GUIDELINES:
11. If yesterday's plan exists, acknowledge it - reference continuity
12. If they followed the plan, celebrate their discipline
13. If they diverged, explore why with curiosity (not judgment)
14. Build today's plan as the NEXT CHAPTER in their ongoing story
15. Use yesterday's lessons to inform today's quest
16. Create narrative continuity: "Yesterday you [X], today you shall [Y]..."
```

---

## Edge Function Logic

### Main Flow

```typescript
export async function handler(req: Request) {
  // 1. Authenticate
  const user = await authenticateRequest(req);

  // 2. Parse user input
  const { userMessage } = await req.json();

  // 3. Get user's local date
  const userProfile = await getUserProfile(user.id);
  const localDate = getLocalDateString(userProfile.timezone_name, userProfile.daily_reset_time);

  // 4. Get last plan
  const lastPlan = await getLastRevelationPlan(user.id);
  const isNewDay = !lastPlan || lastPlan.plan_date !== localDate;

  // 5. Handle day transition
  let yesterdaySummary = null;
  if (isNewDay && lastPlan) {
    // Get or generate yesterday's summary
    yesterdaySummary = await getDailySummary(user.id, lastPlan.plan_date);

    if (!yesterdaySummary) {
      const yesterdayData = await collectYesterdayData(user.id, lastPlan.plan_date);
      yesterdaySummary = await generateDailySummary(user.id, lastPlan, yesterdayData);
      await saveDailySummary(yesterdaySummary);
    }
  }

  // 6. Collect all context
  const context = await collectRevelationContext(user.id);

  // 7. Build prompt with continuity
  const prompt = buildRevelationPrompt({
    ...context,
    lastPlan,
    yesterdaySummary,
    isNewDay,
    userMessage
  });

  // 8. Call LLM
  const revelation = await callLLM(prompt);

  // 9. Save new plan
  await saveRevelationPlan({
    user_id: user.id,
    plan_date: localDate,
    revelation_text: revelation.revelation,
    next_quest: revelation.thePath.nextQuest,
    witnessing: revelation.witnessing,
    todays_plan: revelation.todaysPlan,
    wisdom: revelation.wisdomForTheJourney,
    user_context: userMessage
  });

  // 10. Return revelation (include yesterday's summary if exists)
  return new Response(JSON.stringify({
    ...revelation,
    yesterdaySummary: yesterdaySummary
  }), {
    headers: { 'Content-Type': 'application/json' }
  });
}
```

### Helper Functions

```typescript
// Get yesterday's actual data
async function collectYesterdayData(userId: string, date: string) {
  // Get all pomodoros from that date
  const { data: pomodoros } = await supabase
    .from('pomodoros')
    .select('*, tasks(title)')
    .eq('user_id', userId)
    .gte('completed_at', `${date} 00:00:00`)
    .lt('completed_at', `${date} 23:59:59`);

  // Get daily task completions for that date
  const { data: dailyCompletions } = await supabase
    .from('daily_task_completions')
    .select('*, tasks(title)')
    .eq('user_id', userId)
    .eq('date', date);

  // Get one-time tasks completed that day
  const { data: completedTasks } = await supabase
    .from('tasks')
    .select('title, completed_at')
    .eq('user_id', userId)
    .gte('completed_at', `${date} 00:00:00`)
    .lt('completed_at', `${date} 23:59:59`)
    .eq('is_completed', true);

  // Calculate metrics
  const pomodorosCount = pomodoros?.length || 0;
  const totalMinutes = pomodoros?.reduce((sum, p) => sum + p.duration_minutes, 0) || 0;
  const tasksCompleted = completedTasks?.map(t => t.title) || [];
  const tasksAttempted = [...new Set(pomodoros?.map(p => p.tasks?.title).filter(Boolean))] || [];
  const dailyTasksDone = dailyCompletions?.every(dc => dc.is_completed) || false;

  return {
    pomodoros_completed: pomodorosCount,
    total_minutes: totalMinutes,
    tasks_completed: tasksCompleted,
    tasks_attempted: tasksAttempted,
    daily_tasks_done: dailyTasksDone,
    quest_status: 'unknown' // Will be determined by LLM
  };
}

// Generate summary using LLM
async function generateDailySummary(userId: string, lastPlan: any, actualData: any) {
  const prompt = buildDailySummaryPrompt(lastPlan, actualData);
  const response = await callLLM(prompt, { maxTokens: 500 }); // Shorter, focused response

  return {
    user_id: userId,
    summary_date: lastPlan.plan_date,
    plan_id: lastPlan.id,
    summary_data: actualData,
    narrative_summary: response.narrative_summary,
    growth_insights: response.growth_insights
  };
}
```

---

## UI Enhancements

### Yesterday's Summary Display

When user opens Revelation modal on a new day:

```tsx
{yesterdaySummary && (
  <div className="yesterdays-chapter">
    <h3>üìú Yesterday's Chapter</h3>
    <div className="summary-card">
      <div className="date">
        {formatDate(yesterdaySummary.summary_date)}
      </div>

      <div className="narrative">
        <p>{yesterdaySummary.narrative_summary}</p>
      </div>

      {yesterdaySummary.growth_insights.strengths_shown.length > 0 && (
        <div className="strengths">
          <h4>üí™ Strengths You Showed</h4>
          <ul>
            {yesterdaySummary.growth_insights.strengths_shown.map((s, i) => (
              <li key={i}>{s}</li>
            ))}
          </ul>
        </div>
      )}

      {yesterdaySummary.growth_insights.challenges_faced.length > 0 && (
        <div className="challenges">
          <h4>‚öîÔ∏è Challenges Faced</h4>
          <ul>
            {yesterdaySummary.growth_insights.challenges_faced.map((c, i) => (
              <li key={i}>{c}</li>
            ))}
          </ul>
        </div>
      )}

      <div className="lesson">
        <span className="icon">‚ú®</span>
        <p>{yesterdaySummary.lessons_for_today}</p>
      </div>
    </div>
  </div>
)}
```

### Continuity Indicator

Show plan history:

```tsx
<div className="plan-continuity">
  <button onClick={() => setShowHistory(!showHistory)}>
    üìñ View Your Legend (Last 7 Days)
  </button>

  {showHistory && (
    <div className="plan-history">
      {plans.map(plan => (
        <div key={plan.id} className="history-entry">
          <div className="date">{formatDate(plan.plan_date)}</div>
          <div className="quest">{plan.next_quest.title}</div>
          <div className="status">
            {plan.was_quest_started ? (
              plan.quest_completed_at ? '‚úì Completed' : '‚öîÔ∏è Attempted'
            ) : '‚óã Not started'}
          </div>
        </div>
      ))}
    </div>
  )}
</div>
```

---

## Benefits of This Approach

### 1. Continuity Creates Meaning
- Each day connects to the last
- User sees their journey as a story, not isolated events
- "Yesterday I [X], today I [Y]" creates narrative flow

### 2. Reflection Builds Awareness
- Daily summaries force acknowledgment of what happened
- Patterns become visible over time
- Growth is documented and celebrated

### 3. Accountability Without Shame
- LLM sees if plan was followed
- Divergence is explored with curiosity, not judgment
- "Why did you choose differently?" instead of "You failed"

### 4. Learning Over Time
- LLM learns user's patterns
- Adjusts recommendations based on what actually works
- Becomes more personalized with each day

### 5. Emotional Impact
- Summaries celebrate victories (emotional value)
- Acknowledges struggles (witnessing)
- Shows growth over time (meaning)
- Makes every day part of a larger quest (re-enchantment)

---

## Implementation Priority

### Phase 1: Database & Basic Tracking
1. Create `revelation_plans` table
2. Create `daily_summaries` table
3. Update Edge Function to save plans
4. Add quest completion trigger

### Phase 2: Daily Summary Generation
1. Implement day transition detection
2. Build `collectYesterdayData` function
3. Create daily summary prompt
4. Generate and store summaries

### Phase 3: Continuity Integration
1. Update main Revelation prompt with continuity sections
2. Pass last plan and yesterday summary to LLM
3. Test narrative continuity

### Phase 4: UI Enhancements
1. Display yesterday's summary in modal
2. Add plan history view
3. Show quest completion status
4. Visualize streak of plan adherence

---

## Example: A Day in the Life

### Day 1 (Monday Morning)
**User**: Seeks Revelation
**System**: No previous plan, generates first Revelation
**LLM**: "Your legend begins now. Your next quest: Master the ancient texts (Study ML paper for 90 min)..."
**Stored**: Plan for Monday

### Day 1 (Monday Evening)
**User**: Seeks Revelation again
**System**: Same day, returns existing plan or updates if needed
**Note**: Can allow multiple revelations per day, but plan_date stays same

### Day 2 (Tuesday Morning)
**User**: Seeks Revelation
**System**: Detects new day!
**Step 1**: Collect Monday's data (did they do the quest? what else happened?)
**Step 2**: Generate Monday's summary via LLM
**Summary**: "Yesterday, you faced the ancient texts with courage, completing 2 Pomodoros of focused study. Though you fell short of the 90-minute goal, you demonstrated discipline by beginning the quest. Your legend grows..."
**Step 3**: Send summary + Monday's plan to LLM for Tuesday's Revelation
**LLM**: "Yesterday you began your scholarly journey. Today, you shall continue the mastery. Your next quest: Complete the ancient text analysis (Study ML paper - 60 min, building on yesterday)..."
**Stored**: Plan for Tuesday, Summary for Monday

### Day 3 (Wednesday Morning)
**User**: Seeks Revelation
**System**: Tuesday summary + plan ‚Üí Wednesday Revelation
**Continuity**: "For two days you have walked the path of knowledge. Today you consolidate your power..."

---

## Conclusion

This continuity system transforms Revelation from a daily snapshot into a **living chronicle of the hero's journey**. Each day builds on the last, creating:

- **Meaningful narrative** instead of disconnected advice
- **Reflection and growth** instead of just forward motion
- **Accountability** without shame
- **Learning** that improves over time
- **A legend** that unfolds, chapter by chapter

The user's life becomes a story worth living, and Revelation becomes the wise chronicler who witnesses, guides, and celebrates every step of the journey.
